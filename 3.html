<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hidden Camera Detector</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f2f5; text-align: center; padding: 20px; }
    #video { border: 2px solid #6c757d; border-radius: 8px; max-width: 100%; }
    #strengthBar { width: 80%; height: 25px; margin: 20px auto; }
    .alert-text { font-size: 1.3rem; color: #d00; margin-top: 10px; display: none; }
    .slider-and-button { margin-top: 20px; }
  </style>
</head>
<body>
  <h1 class="mb-4">üì∑ Hidden Camera Detector</h1>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  <progress id="strengthBar" value="0" max="100" class="progress"></progress>
  <div class="alert-text" id="alertText">‚ö†Ô∏è Potential Camera Detected!</div>

  <div class="slider-and-button">
    <label>Sensitivity (Threshold): <span id="thresholdValue">240</span></label><br>
    <input type="range" id="thresholdRange" min="200" max="255" value="240">
  </div>

  <button class="btn btn-primary mt-3" id="startButton">Start Detection with Buzzer</button>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const strengthBar = document.getElementById("strengthBar");
    const alertText = document.getElementById("alertText");
    const thresholdRange = document.getElementById("thresholdRange");
    const thresholdValue = document.getElementById("thresholdValue");
    const startButton = document.getElementById("startButton");
    let threshold = parseInt(thresholdRange.value);

    thresholdRange.addEventListener("input", () => {
      threshold = parseInt(thresholdRange.value);
      thresholdValue.textContent = threshold;
    });

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();
      } catch (err) {
        alert("Camera access error: " + err.message);
      }
    }
    window.addEventListener('load', initCamera);

    let audioCtx, osc, gainNode;
    let consecutiveCount = 0;

    startButton.addEventListener("click", () => {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      osc = audioCtx.createOscillator();
      gainNode = audioCtx.createGain();
      osc.connect(gainNode).connect(audioCtx.destination);
      osc.type = "square";
      osc.frequency.value = 0;
      gainNode.gain.value = 0;
      osc.start();

      detectLoop();
      startButton.disabled = true;
    });

    function detectLoop() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let brightSpots = 0;

      // Only count pixels in a central 200x200 area to avoid random reflections
      const startX = canvas.width / 2 - 100;
      const startY = canvas.height / 2 - 100;
      for (let y = startY; y < startY + 200; y += 5) {
        for (let x = startX; x < startX + 200; x += 5) {
          const i = (y * canvas.width + x) * 4;
          const b = (frame.data[i] + frame.data[i+1] + frame.data[i+2]) / 3;
          if (b > threshold) brightSpots++;
        }
      }

      // Normalize for progress bar (max 200 spots)
      const strength = Math.min(brightSpots, 200);
      strengthBar.value = (strength / 200) * 100;

      // Trigger only if bright spots persist across 5 consecutive frames
      if (strength > 5) consecutiveCount++;
      else consecutiveCount = 0;

      if (consecutiveCount >= 5) {
        alertText.style.display = "block";
        osc.frequency.value = 400 + strength * 2;
        gainNode.gain.value = 0.2;
      } else {
        alertText.style.display = "none";
        osc.frequency.value = 0;
        gainNode.gain.value = 0;
      }

      requestAnimationFrame(detectLoop);
    }
  </script>
</body>
</html>
